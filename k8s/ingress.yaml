apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: harmony-ingress
  namespace: harmony
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/ssl-passthrough: "false"
    nginx.ingress.kubernetes.io/ssl-ciphers: "ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA384:AES128-SHA:AES256-SHA"
    nginx.ingress.kubernetes.io/ssl-protocols: "TLSv1.2 TLSv1.3"
    nginx.ingress.kubernetes.io/limit-connections: "100"
    nginx.ingress.kubernetes.io/limit-rps: "50"
    nginx.ingress.kubernetes.io/rate-limit-window: "1m"
    nginx.ingress.kubernetes.io/rate-limit-window-log-format: "$remote_addr - $remote_user [$time_local] \"$request\" $status $body_bytes_sent \"$http_referer\" \"$http_user_agent\" $request_time $upstream_response_time"
    nginx.ingress.kubernetes.io/rate-limit-window-log-level: "notice"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    kubernetes.io/tls-acme: "true"
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "X-Frame-Options: DENY";
      more_set_headers "X-Content-Type-Options: nosniff";
      more_set_headers "X-XSS-Protection: 1; mode=block";
      more_set_headers "Referrer-Policy: strict-origin-when-cross-origin";
      more_set_headers "Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: https://*.harmony.app https://*.cloudinary.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://api.harmony.app https://*.harmony.app https://*.stripe.com https://*.clerk.com; media-src 'self' https://*.harmony.app https://*.cloudinary.com; object-src 'none'; frame-src 'self' https://*.stripe.com https://*.clerk.com; worker-src 'self' blob:; form-action 'self'; base-uri 'self'; frame-ancestors 'none';"
      more_set_headers "Strict-Transport-Security: max-age=31536000; includeSubDomains; preload"
spec:
  tls:
    - hosts:
        - api.harmony.app
      secretName: harmony-api-tls
    - hosts:
        - app.harmony.app
      secretName: harmony-app-tls
    - hosts:
        - www.harmony.app
      secretName: harmony-www-tls
    - hosts:
        - harmony.app
      secretName: harmony-root-tls
  rules:
    - host: api.harmony.app
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: harmony-backend-service
                port:
                  number: 80
          - path: /auth
            pathType: Prefix
            backend:
              service:
                name: harmony-backend-service
                port:
                  number: 80
          - path: /users
            pathType: Prefix
            backend:
              service:
                name: harmony-backend-service
                port:
                  number: 80
          - path: /artists
            pathType: Prefix
            backend:
              service:
                name: harmony-backend-service
                port:
                  number: 80
          - path: /music
            pathType: Prefix
            backend:
              service:
                name: harmony-backend-service
                port:
                  number: 80
          - path: /ai
            pathType: Prefix
            backend:
              service:
                name: harmony-ai-service-service
                port:
                  number: 80
          - path: /uploads
            pathType: Prefix
            backend:
              service:
                name: harmony-backend-service
                port:
                  number: 80
          - path: /analytics
            pathType: Prefix
            backend:
              service:
                name: harmony-backend-service
                port:
                  number: 80
          - path: /search
            pathType: Prefix
            backend:
              service:
                name: harmony-backend-service
                port:
                  number: 80
          - path: /recommendations
            pathType: Prefix
            backend:
              service:
                name: harmony-backend-service
                port:
                  number: 80
          - path: /social
            pathType: Prefix
            backend:
              service:
                name: harmony-backend-service
                port:
                  number: 80
          - path: /subscriptions
            pathType: Prefix
            backend:
              service:
                name: harmony-backend-service
                port:
                  number: 80
          - path: /premium-features
            pathType: Prefix
            backend:
              service:
                name: harmony-backend-service
                port:
                  number: 80
          - path: /webhooks
            pathType: Prefix
            backend:
              service:
                name: harmony-backend-service
                port:
                  number: 80

    - host: app.harmony.app
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: harmony-frontend-service
                port:
                  number: 80
          - path: /auth
            pathType: Prefix
            backend:
              service:
                name: harmony-frontend-service
                port:
                  number: 80
          - path: /dashboard
            pathType: Prefix
            backend:
              service:
                name: harmony-frontend-service
                port:
                  number: 80
          - path: /library
            pathType: Prefix
            backend:
              service:
                name: harmony-frontend-service
                port:
                  number: 80
          - path: /search
            pathType: Prefix
            backend:
              service:
                name: harmony-frontend-service
                port:
                  number: 80
          - path: /artists
            pathType: Prefix
            backend:
              service:
                name: harmony-frontend-service
                port:
                  number: 80
          - path: /playlists
            pathType: Prefix
            backend:
              service:
                name: harmony-frontend-service
                port:
                  number: 80
          - path: /settings
            pathType: Prefix
            backend:
              service:
                name: harmony-frontend-service
                port:
                  number: 80
          - path: /profile
            pathType: Prefix
            backend:
              service:
                name: harmony-frontend-service
                port:
                  number: 80
          - path: /ai-artist
            pathType: Prefix
            backend:
              service:
                name: harmony-frontend-service
                port:
                  number: 80
          - path: /prompt-rewriter
            pathType: Prefix
            backend:
              service:
                name: harmony-frontend-service
                port:
                  number: 80

    - host: www.harmony.app
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: harmony-frontend-service
                port:
                  number: 80

    - host: harmony.app
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: harmony-frontend-service
                port:
                  number: 80

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: harmony-ingress-internal
  namespace: harmony
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "X-Frame-Options: DENY";
      more_set_headers "X-Content-Type-Options: nosniff";
      more_set_headers "X-XSS-Protection: 1; mode=block";
      more_set_headers "Referrer-Policy: strict-origin-when-cross-origin";
      more_set_headers "Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self'; object-src 'none'; frame-src 'self'; worker-src 'self' blob:; form-action 'self'; base-uri 'self'; frame-ancestors 'none';"
spec:
  rules:
    - host: harmony.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: harmony-frontend-service
                port:
                  number: 80
          - path: /api
            pathType: Prefix
            backend:
              service:
                name: harmony-backend-service
                port:
                  number: 80
          - path: /auth
            pathType: Prefix
            backend:
              service:
                name: harmony-backend-service
                port:
                  number: 80
          - path: /users
            pathType: Prefix
            backend:
              service:
                name: harmony-backend-service
                port:
                  number: 80
          - path: /artists
            pathType: Prefix
            backend:
              service:
                name: harmony-backend-service
                port:
                  number: 80
          - path: /music
            pathType: Prefix
            backend:
              service:
                name: harmony-backend-service
                port:
                  number: 80
          - path: /ai
            pathType: Prefix
            backend:
              service:
                name: harmony-ai-service-service
                port:
                  number: 80
          - path: /uploads
            pathType: Prefix
            backend:
              service:
                name: harmony-backend-service
                port:
                  number: 80
          - path: /analytics
            pathType: Prefix
            backend:
              service:
                name: harmony-backend-service
                port:
                  number: 80
          - path: /search
            pathType: Prefix
            backend:
              service:
                name: harmony-backend-service
                port:
                  number: 80
          - path: /recommendations
            pathType: Prefix
            backend:
              service:
                name: harmony-backend-service
                port:
                  number: 80
          - path: /social
            pathType: Prefix
            backend:
              service:
                name: harmony-backend-service
                port:
                  number: 80
          - path: /subscriptions
            pathType: Prefix
            backend:
              service:
                name: harmony-backend-service
                port:
                  number: 80
          - path: /premium-features
            pathType: Prefix
            backend:
              service:
                name: harmony-backend-service
                port:
                  number: 80
          - path: /webhooks
            pathType: Prefix
            backend:
              service:
                name: harmony-backend-service
                port:
                  number: 80

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: harmony-prometheus-ingress
  namespace: harmony
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    nginx.ingress.kubernetes.io/whitelist-source-range: "10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"
    nginx.ingress.kubernetes.io/auth-type: basic
    nginx.ingress.kubernetes.io/auth-secret: prometheus-auth
    nginx.ingress.kubernetes.io/auth-realm: "Authentication Required"
spec:
  rules:
    - host: prometheus.harmony.app
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: harmony-prometheus-service
                port:
                  number: 9090

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: harmony-grafana-ingress
  namespace: harmony
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    nginx.ingress.kubernetes.io/whitelist-source-range: "10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"
    nginx.ingress.kubernetes.io/auth-type: basic
    nginx.ingress.kubernetes.io/auth-secret: grafana-auth
    nginx.ingress.kubernetes.io/auth-realm: "Authentication Required"
spec:
  rules:
    - host: grafana.harmony.app
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: harmony-grafana-service
                port:
                  number: 3000

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: harmony-rabbitmq-ingress
  namespace: harmony
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    nginx.ingress.kubernetes.io/whitelist-source-range: "10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"
    nginx.ingress.kubernetes.io/auth-type: basic
    nginx.ingress.kubernetes.io/auth-secret: rabbitmq-auth
    nginx.ingress.kubernetes.io/auth-realm: "Authentication Required"
spec:
  rules:
    - host: rabbitmq.harmony.app
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: harmony-rabbitmq-service
                port:
                  number: 15672